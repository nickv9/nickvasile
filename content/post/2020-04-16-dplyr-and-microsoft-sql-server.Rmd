---
title: dplyr and Microsoft SQL Server
author: Nicholas Vasile
date: '2020-04-16'
slug: dplyr-and-microsoft-sql-server
categories: []
tags: []
---

**This post is a work in progress**

## Motivation

I use R to access data held in Microsoft SQL Server databases on a daily basis. As a result of running into problems, I've realized I don't have an understanding of the specific roles different components, notably dbplyr, odbc and dbi each play in the process. As a result, resolving or mitigating issues is often an inefficient combination of Google searches and trial and error. Additionally, as I find or develop workarounds, I am unwilling to promote them with others because I don't fully understand the cause of the issue and, as a result, I am not confident I have addressed the problem at the appropriate level. 

Specifically, this is most motivated by the, "Invalid descriptor index," error documented [here](https://github.com/r-dbi/odbc/issues/309 ).

## Scope

Given that the source of my motivation is encountering problems when working with data in Microsoft SQL Server databases, this investigation will be focused on how R interfaces with Microsoft SQL server.

Additionally, I'm a relatively new R user and do all my R work in RStudio. I use the dplyr packageextensively so this will be centered on how dplyr interfaces with data held in a Microsoft SQL database.

## dplyr and dbplyr packages

dbplyr is the database back-end for dplyr - it does not need to be loaded explicitly, it is loaded by dplyr when working with data in a database.

dbplyr translates dplyr code into vendor specific SQL. 

dbplyr has translations for the following database systems:

* Microsoft SQL Server
* Oracle
* Apache Hive
* Apache Impala
* PostgreSQL
* Amazon Redshift

What, "translation," means is that dplyr syntax can be used to retrieve data from a database system without the need to write SQL code.

The DBI package is used by dbplyr as an intermediary for connections with the database.

Note that even if dbplyr does not contain translations for a specific database, DBI and odbc packages can be used to connect and the user can send raw SQL queries. 

## DBI package

DBI package provides a consistent set of functions regardless of the database type being accessed.

DBI is, "middle-ware," between an interactive user, or other packages, and the database.

DBI itself actually segments the connectivity to the database into a, "front-end," and a, "back-end."

DBI implements a standardized front-end, and other components act as drivers to interface with the specific back-end.

Example back-end packages include: 

* RPostgres
* RMariaDB
* RSQLite
* odbc
* bigrquery

An example of front-end functionality provided by DBI...

* connect/disconnect to the DBMS
* create and execute statements in the DBMS
* extract results/output from statements
* error/exception handling
* information (meta-data) from database objects
* transaction management (optional)

SOURCES: 

* `vignette("DBI", package = "DBI")`
* https://db.rstudio.com/getting-started/database-queries 
* https://www.r-consortium.org/blog/2017/05/15/improving-dbi-a-retrospect
* `vignette("spec",package="DBI")`

## odbc package

The odbc package provides the DBI back-end to any odbc driver connection, including those for Microsoft SQL Server.

This enables a connection to any database with ODBC drivers available.

TODO: what back-end functions does odbc provide?

SOURCE: https://db.rstudio.com/odbc/ 

## ODBC drivers


# Q and A

* Q: What does is the implication of dbplyr having, or not having, translations for a specific database?
    + A: If dbplyr has the translation then data can be retrieved from a database using dplyr syntax, without the need to write SQL code. If dbplyr does not have translations, you will need to write the SQL code yourself and use DBI and odbc packages to send queries.

* Q: Does each "front-end" function in DBI have a "back-end" equivalent of the same name in odbc?'

Let's start by looking at the exports of each and comparing them.

```{r}
library(DBI)
library(odbc)

dbi_exports <- ls("package:DBI")

odbc_exports <- ls("package:odbc")
```

functions exported by DBI, not exported by odbc...

```{r}
setdiff(dbi_exports, odbc_exports)
```

Well, quite a few! So the short answer is, "no," there are functions in DBI that are not present in odbc. 

Given that some of these start with db*, lends me to believe that not all DBI back-ends implement all DBI front-ends.

What about functions exported by odbc, that are not also present in DBI?

```{r}
setdiff(odbc_exports, dbi_exports)
```

Well much fewer. It seems logical to me that back-end packages would have their own unique functions so I am not suprised.

What about what is exported by both packages?

```{r}
intersect(dbi_exports, odbc_exports)
```

Looks like common functions all start with either db* or sql*, with the excption of `show()`

Note that when I check odbc for some of the db* functions, like dbBegin I don't actually see them - but I do see them in DBI. I do see both `DBI::dbCOnnect()` and `odbc::dbConnect()`.

What I do see in odbc are entries like these..

![](/post/2020-04-16-dplyr-and-microsoft-sql-server_files/odbc_pure_virtual_functions.png)

Notice the description for the help says

> Implementations of pure virtual functions defined in the DBI package for OdbcConnection objects.

According to [this article](https://techdifferences.com/difference-between-virtual-function-and-pure-virtual-function.html):

> The main difference between ‘virtual function’ and ‘pure virtual function’ is that ‘virtual function’ has its definition in the base class and also the inheriting derived classes redefine it.

What I *think* this is saying is that odbc is implementing pure virtual functions dictated by DBI. 

I didn't check them all but a quick spot-check of the overlapping db* functions indicates they may all be pure virtual functions, to be implemented in a back-end. 

The question is, where are these actually implemented - TODO: I assume in the odbc driver - but how to validate this assumption?

SOURCES and other Resources to read: 
Read  https://dbi.r-dbi.org/


https://dbplyr.tidyverse.org/

https://github.com/r-dbi/DBI    

TODO: Hadleys recommended SQL learning resources for those with some familiarity  (SOURCE: https://dbplyr.tidyverse.org/articles/dbplyr.html):

* https://www.sqlite.org/queryplanner.html
* https://blog.jooq.org/2016/03/17/10-easy-steps-to-a-complete-understanding-of-sql/
