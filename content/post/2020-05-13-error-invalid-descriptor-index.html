---
title: 'Debugging the Invalid Descriptor Index Error' 
author: Nick Vasile
date: '2020-05-13'
slug: error-invalid-descriptor-index
categories: []
tags: []
---



<p><strong>This post is a work in progress</strong></p>
<div id="motivation" class="section level1">
<h1>Motivation</h1>
<p>I use the dbplyr, dplyr, DBI and odbc R packages to extract data held in Microsoft SQL on a daily basis.</p>
<p>I used to run into the, “Invalid Descriptor Index,” error documented <a href="https://github.com/r-dbi/odbc/issues/309">here</a> constantly. It was awful! I spent so much time trying to find the, “problem,” columns in tables that often had over 100 columns. The time I spent trying to get my queries to work severely reduced the time I had available to clean, transform and analyze my data.</p>
<p>Through the work of many great people sharing their expertise on GitHub, I was able to identify <a href="https://github.com/r-dbi/odbc/issues/309#issuecomment-615255613">a workaround that worked well for me</a>.</p>
<p>The workaround helped <em>me</em> continue my daily work but did nothing to <em>prevent</em> <em>others</em> from encountering the same issue in the future. One of the great things about R is the community and I would like to do my part to help. That might involve making a code change in a package or in another component involved.</p>
<p>I don’t yet have a firm grasp on what, from a technical standpoint, leads to the failure but I do know many things are involved - specifically multiple R packages, ODBC drivers and Microsoft SQL Server.</p>
<p>I am comfortable as an R user and debugging C++ code individually but have not spent much time debugging multi-component issues in R.</p>
<p>This investigation is an opportunity for me:</p>
<ul>
<li>Advance my R debugging skills so I well-armed to tackle other multi-component R issues in the future</li>
<li>Understand, at a deep level, the root cause, and contributing factors, of the failure that leads to this error. With that understanding I will be a much better position to propose, evaluate and contribute to solutions.</li>
</ul>
</div>
<div id="scope" class="section level1">
<h1>Scope</h1>
<p>I’ll be reproducing this issue using Microsoft SQL Server Express which is a free download available <a href="https://www.microsoft.com/en-us/sql-server/sql-server-downloads">here</a>.</p>
<p>I’ll be focusing my analysis on when this error occurs running R on the Microsoft Windows operating system.</p>
</div>
<div id="reproducing-the-problem" class="section level1">
<h1>Reproducing the problem</h1>
<p>I’ll write two different sets of data:</p>
<ol style="list-style-type: decimal">
<li>A table, “##problem_data,” with, “long” columns that are not the last columns in the table.</li>
<li>A table, “##working_data,” with the same data, only this time with the, “long,” column at the end of the table.</li>
</ol>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## -- Attaching packages --------------------------------------------------------------------------------------------------------------------- tidyverse 1.3.0 --</code></pre>
<pre><code>## v ggplot2 3.3.0     v purrr   0.3.3
## v tibble  2.1.3     v dplyr   0.8.5
## v tidyr   1.0.2     v stringr 1.4.0
## v readr   1.3.1     v forcats 0.5.0</code></pre>
<pre><code>## Warning: package &#39;tidyr&#39; was built under R version 3.6.3</code></pre>
<pre><code>## Warning: package &#39;forcats&#39; was built under R version 3.6.3</code></pre>
<pre><code>## -- Conflicts ------------------------------------------------------------------------------------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>user_name &lt;-
  keyring::key_list(&quot;dbi_test&quot;)$username

con &lt;- DBI::dbConnect(
      odbc::odbc(),
      Driver = &quot;SQL Server&quot;,
      Server = &quot;testsqlserver&quot;,
      UID = user_name,
      PWD = keyring::key_get(&quot;dbi_test&quot;, user_name)
   )

dplyr::copy_to(con,
               tibble(a = 1:3, 
                      b = blob::blob(raw(1)), #blob data NOT at end of table
                      c = 1
                      ),
               &quot;problem_data&quot;, # will expose problem
               temporary = TRUE
               )</code></pre>
<pre><code>## Created a temporary table named: ##problem_data</code></pre>
<pre class="r"><code>dplyr::copy_to(con,
               tibble(a = 1:3,
                      c = 1,
                      b = blob::blob(raw(1)) # blob data at end of table
                      ),
               &quot;working_data&quot;, # will not expose problem
               temporary = TRUE
               )</code></pre>
<pre><code>## Created a temporary table named: ##working_data</code></pre>
<p>Here the problem occurs - because the column with, “long,” data is NOT the the last column in the table.</p>
<pre class="r"><code>dplyr::tbl(con,&quot;##problem_data&quot;)</code></pre>
<pre><code>## Error in result_fetch(res@ptr, n): nanodbc/nanodbc.cpp:3186: 07009: [Microsoft][ODBC SQL Server Driver]Invalid Descriptor Index</code></pre>
<pre><code>## Warning in dbClearResult(res): Result already cleared</code></pre>
<p>Here the problem does not occur - because the column with “long” data is the last column in the table.</p>
<pre class="r"><code>dplyr::tbl(con, &quot;##working_data&quot;)</code></pre>
<pre><code>## # Source:   table&lt;##working_data&gt; [?? x 3]
## # Database: Microsoft SQL Server
## #   15.00.2000[dbo@FTLLYUNGTINGF01\SQLEXPRESS/master]
##       a     c         b
##   &lt;int&gt; &lt;dbl&gt;    &lt;blob&gt;
## 1     1     1 &lt;raw 1 B&gt;
## 2     2     1 &lt;raw 1 B&gt;
## 3     3     1 &lt;raw 1 B&gt;</code></pre>
<p>SOURCE: <a href="https://github.com/r-dbi/odbc/issues/309#issue-507726267" class="uri">https://github.com/r-dbi/odbc/issues/309#issue-507726267</a></p>
</div>
<div id="debugging-the-error" class="section level1">
<h1>Debugging the error</h1>
<p>One of the primary motivations for this post is to force me to advance my debugging skills.</p>
<p>I decided to start with <a href="https://adv-r.hadley.nz/debugging.html">the debugging chapter from Hadley Wickham’s Advanced R book</a>.</p>
<div id="debugging-step-1-google-it" class="section level2">
<h2>Debugging Step 1: Google it!</h2>
<p>I started out by Googling a portion of the error string, “<code>[Microsoft][ODBC SQL Server Driver]Invalid Descriptor Index</code>,” which yielded quite a few relevant hits, including a surprising amount of duplicate GitHub issues raised in the odbc project.</p>
<p>Based on Hadley’s recommendation in the book I decided to check out the <a href="https://github.com/r-assist/errorist">errorist package</a> which gave me much more target hits because it included the entire text of the error message in the search string. It was also automatic, saving me a second or two of copying and pasting. I’ll be incorporating this package into my debugging work-flow going forward!</p>
<p>I’ve captured a list of relevant issues, and the Stack Overflow thread I found most helpful in the <a href="#issues">Appendix</a>.</p>
<p>Here is what I gleaned:</p>
<ol style="list-style-type: decimal">
<li>TODO: something about this being caused by a ODBC (the Microsoft C interface - not the R odbc package) constraint.</li>
<li>TODO: The workaround is to put “long” columns at the end of the select statement - there are a few different ways to do this</li>
<li>TODO: doesn’t occur with: 1) RStudio’s professional drivers which are part of their commercial (you need to pay for) offerings 2) RODBC package 3) FreeTDS drivers (*nix systems only)</li>
</ol>
</div>
</div>
<div id="issues" class="section level1">
<h1>Appendix: Some Reports of, and references to, this issue</h1>
<p>Issues logged against odbc R package:</p>
<ul>
<li><a href="https://github.com/r-dbi/odbc/issues/10" class="uri">https://github.com/r-dbi/odbc/issues/10</a></li>
<li><a href="https://github.com/r-dbi/odbc/issues/86" class="uri">https://github.com/r-dbi/odbc/issues/86</a></li>
<li><a href="https://github.com/r-dbi/odbc/issues/112" class="uri">https://github.com/r-dbi/odbc/issues/112</a></li>
<li><a href="https://github.com/r-dbi/odbc/issues/256" class="uri">https://github.com/r-dbi/odbc/issues/256</a></li>
<li><a href="https://github.com/r-dbi/odbc/issues/309" class="uri">https://github.com/r-dbi/odbc/issues/309</a></li>
</ul>
<p>Issues logged against nanodbc:</p>
<ul>
<li><a href="https://github.com/nanodbc/nanodbc/issues/149" class="uri">https://github.com/nanodbc/nanodbc/issues/149</a></li>
</ul>
<p>Most Helpful (to me) Stack Overflow thread:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/45001152/r-dbi-odbc-error-nanodbc-nanodbc-cpp3110-07009-microsoftodbc-driver-13-fo" class="uri">https://stackoverflow.com/questions/45001152/r-dbi-odbc-error-nanodbc-nanodbc-cpp3110-07009-microsoftodbc-driver-13-fo</a></li>
</ul>
</div>
<div id="qa" class="section level1">
<h1>Q&amp;A</h1>
<p>Q: What constitutes “long” data?
A:</p>
</div>
