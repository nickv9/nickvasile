---
title: dplyr and Microsoft SQL Server
author: Nicholas Vasile
date: '2020-04-16'
slug: dplyr-and-microsoft-sql-server
categories: []
tags: []
---



<p><strong>This post is a work in progress</strong></p>
<div id="motivation" class="section level2">
<h2>Motivation</h2>
<p>I use R to access data held in Microsoft SQL Server databases on a daily basis. As a result of running into problems, I’ve realized I don’t have an understanding of the specific roles different components, notably dbplyr, odbc and dbi each play in the process. As a result, resolving or mitigating issues is often an inefficient combination of Google searches and trial and error. Additionally, as I find or develop workarounds, I am unwilling to promote them with others because I don’t fully understand the cause of the issue and, as a result, I am not confident I have addressed the problem at the appropriate level.</p>
<p>Specifically, this is most motivated by the, “Invalid descriptor index,” error documented <a href="https://github.com/r-dbi/odbc/issues/309">here</a>.</p>
</div>
<div id="scope" class="section level2">
<h2>Scope</h2>
<p>Given that the source of my motivation is encountering problems when working with data in Microsoft SQL Server databases, this investigation will be focused on how R interfaces with Microsoft SQL server.</p>
<p>Additionally, I’m a relatively new R user and do all my R work in RStudio. I use the dplyr packageextensively so this will be centered on how dplyr interfaces with data held in a Microsoft SQL database.</p>
</div>
<div id="dplyr-and-dbplyr-packages" class="section level2">
<h2>dplyr and dbplyr packages</h2>
<p>dbplyr is the database back-end for dplyr - it does not need to be loaded explicitly, it is loaded by dplyr when working with data in a database.</p>
<p>dbplyr translates dplyr code into vendor specific SQL.</p>
<p>dbplyr has translations for the following database systems:</p>
<ul>
<li>Microsoft SQL Server</li>
<li>Oracle</li>
<li>Apache Hive</li>
<li>Apache Impala</li>
<li>PostgreSQL</li>
<li>Amazon Redshift</li>
</ul>
<p>What, “translation,” means is that dplyr syntax can be used to retrieve data from a database system without the need to write SQL code.</p>
<p>The DBI package is used by dbplyr as an intermediary for connections with the database.</p>
<p>Note that even if dbplyr does not contain translations for a specific database, DBI and odbc packages can be used to connect and the user can send raw SQL queries.</p>
</div>
<div id="dbi-package" class="section level2">
<h2>DBI package</h2>
<p>DBI package provides a consistent set of functions regardless of the database type being accessed.</p>
<p>DBI is, “middle-ware,” between an interactive user, or other packages, and the database.</p>
<p>DBI itself actually segments the connectivity to the database into a, “front-end,” and a, “back-end.”</p>
<p>DBI implements a standardized front-end, and other components act as drivers to interface with the specific back-end.</p>
<p>Example back-end packages include:</p>
<ul>
<li>RPostgres</li>
<li>RMariaDB</li>
<li>RSQLite</li>
<li>odbc</li>
<li>bigrquery</li>
</ul>
<p>An example of front-end functionality provided by DBI…</p>
<ul>
<li>connect/disconnect to the DBMS</li>
<li>create and execute statements in the DBMS</li>
<li>extract results/output from statements</li>
<li>error/exception handling</li>
<li>information (meta-data) from database objects</li>
<li>transaction management (optional)</li>
</ul>
<p>SOURCES:</p>
<ul>
<li><code>vignette("DBI", package = "DBI")</code></li>
<li><a href="https://db.rstudio.com/getting-started/database-queries" class="uri">https://db.rstudio.com/getting-started/database-queries</a></li>
<li><a href="https://www.r-consortium.org/blog/2017/05/15/improving-dbi-a-retrospect" class="uri">https://www.r-consortium.org/blog/2017/05/15/improving-dbi-a-retrospect</a></li>
<li><code>vignette("spec",package="DBI")</code></li>
</ul>
</div>
<div id="odbc-package" class="section level2">
<h2>odbc package</h2>
<p>The odbc package provides the DBI back-end to any odbc driver connection, including those for Microsoft SQL Server.</p>
<p>TODO: what back-end functions does odbc provide?</p>
</div>
<div id="odbc-drivers" class="section level2">
<h2>ODBC drivers</h2>
</div>
<div id="q-and-a" class="section level1">
<h1>Q and A</h1>
<ul>
<li>Q: What does is the implication of dbplyr having, or not having, translations for a specific database?
<ul>
<li>A: If dbplyr has the translation then data can be retrieved from a database using dplyr syntax, without the need to write SQL code. If dbplyr does not have translations, you will need to write the SQL code yourself and use DBI and odbc packages to send queries.</li>
</ul></li>
<li>Q: Does each “front-end” function in DBI have a “back-end” equivalent of the same name in odbc?’</li>
</ul>
<p>Let’s start by looking at the exports of each and comparing them.</p>
<pre class="r"><code>library(DBI)</code></pre>
<pre><code>## Warning: package &#39;DBI&#39; was built under R version 3.6.3</code></pre>
<pre class="r"><code>library(odbc)</code></pre>
<pre><code>## Warning: package &#39;odbc&#39; was built under R version 3.6.3</code></pre>
<pre class="r"><code>dbi_exports &lt;- ls(&quot;package:DBI&quot;)

odbc_exports &lt;- ls(&quot;package:odbc&quot;)</code></pre>
<p>functions exported by DBI, not exported by odbc…</p>
<pre class="r"><code>setdiff(dbi_exports, odbc_exports)</code></pre>
<pre><code>##  [1] &quot;ANSI&quot;                   &quot;dbAppendTable&quot;          &quot;dbBreak&quot;               
##  [4] &quot;dbCallProc&quot;             &quot;dbCanConnect&quot;           &quot;dbCreateTable&quot;         
##  [7] &quot;dbDriver&quot;               &quot;dbExecute&quot;              &quot;dbGetConnectArgs&quot;      
## [10] &quot;dbGetDBIVersion&quot;        &quot;dbGetException&quot;         &quot;dbIsReadOnly&quot;          
## [13] &quot;dbListConnections&quot;      &quot;dbListObjects&quot;          &quot;dbListResults&quot;         
## [16] &quot;dbQuoteLiteral&quot;         &quot;dbReadTable&quot;            &quot;dbSetDataMappings&quot;     
## [19] &quot;dbUnloadDriver&quot;         &quot;dbUnquoteIdentifier&quot;    &quot;dbWithTransaction&quot;     
## [22] &quot;fetch&quot;                  &quot;Id&quot;                     &quot;isSQLKeyword&quot;          
## [25] &quot;isSQLKeyword.default&quot;   &quot;make.db.names&quot;          &quot;make.db.names.default&quot; 
## [28] &quot;SQL&quot;                    &quot;sqlAppendTable&quot;         &quot;sqlAppendTableTemplate&quot;
## [31] &quot;sqlColumnToRownames&quot;    &quot;sqlCommentSpec&quot;         &quot;sqlInterpolate&quot;        
## [34] &quot;SQLKeywords&quot;            &quot;sqlParseVariables&quot;      &quot;sqlParseVariablesImpl&quot; 
## [37] &quot;sqlQuoteSpec&quot;           &quot;sqlRownamesToColumn&quot;</code></pre>
<p>Well, quite a few! So the short answer is, “no,” there are functions in DBI that are not present in odbc.</p>
<p>Given that some of these start with db*, lends me to believe that not all DBI back-ends implement all DBI front-ends.</p>
<p>What about functions exported by odbc, that are not also present in DBI?</p>
<pre class="r"><code>setdiff(odbc_exports, dbi_exports)</code></pre>
<pre><code>##  [1] &quot;odbc&quot;                             &quot;odbcConnectionActions&quot;           
##  [3] &quot;odbcConnectionColumns&quot;            &quot;odbcConnectionIcon&quot;              
##  [5] &quot;odbcDataType&quot;                     &quot;odbcListColumns&quot;                 
##  [7] &quot;odbcListDataSources&quot;              &quot;odbcListDrivers&quot;                 
##  [9] &quot;odbcListObjects&quot;                  &quot;odbcListObjectTypes&quot;             
## [11] &quot;odbcPreviewObject&quot;                &quot;odbcSetTransactionIsolationLevel&quot;</code></pre>
<p>Well much fewer. It seems logical to me that back-end packages would have their own unique functions so I am not suprised.</p>
<p>What about what is exported by both packages?</p>
<pre class="r"><code>intersect(dbi_exports, odbc_exports)</code></pre>
<pre><code>##  [1] &quot;dbBegin&quot;           &quot;dbBind&quot;            &quot;dbClearResult&quot;    
##  [4] &quot;dbColumnInfo&quot;      &quot;dbCommit&quot;          &quot;dbConnect&quot;        
##  [7] &quot;dbDataType&quot;        &quot;dbDisconnect&quot;      &quot;dbExistsTable&quot;    
## [10] &quot;dbFetch&quot;           &quot;dbGetInfo&quot;         &quot;dbGetQuery&quot;       
## [13] &quot;dbGetRowCount&quot;     &quot;dbGetRowsAffected&quot; &quot;dbGetStatement&quot;   
## [16] &quot;dbHasCompleted&quot;    &quot;dbIsValid&quot;         &quot;dbListFields&quot;     
## [19] &quot;dbListTables&quot;      &quot;dbQuoteIdentifier&quot; &quot;dbQuoteString&quot;    
## [22] &quot;dbRemoveTable&quot;     &quot;dbRollback&quot;        &quot;dbSendQuery&quot;      
## [25] &quot;dbSendStatement&quot;   &quot;dbWriteTable&quot;      &quot;show&quot;             
## [28] &quot;sqlCreateTable&quot;    &quot;sqlData&quot;</code></pre>
<p>Looks like common functions all start with either db* or sql*, with the excption of <code>show()</code></p>
<p>Note that when I check odbc for the db* functions I don’t actually see them - but I do see them in DBI.</p>
<p>What I do see in odbc are entries like these..</p>
<p><img src="/post/2020-04-16-dplyr-and-microsoft-sql-server_files/odbc_pure_virtual_functions.png" /></p>
<p>TODO: <code>dbColumnInfo()</code>, <code>dbDataType()</code>, <code>dbGetInfo()</code>, <code>dbListFields()</code></p>
<p>SOURCES and other Resources to read:</p>
<p><a href="https://dbplyr.tidyverse.org/" class="uri">https://dbplyr.tidyverse.org/</a>
<a href="https://dbi.r-dbi.org/" class="uri">https://dbi.r-dbi.org/</a></p>
<p><a href="https://github.com/r-dbi/DBI" class="uri">https://github.com/r-dbi/DBI</a></p>
<p>Continue reading <a href="https://db.rstudio.com/getting-started/database-queries" class="uri">https://db.rstudio.com/getting-started/database-queries</a> Database Queries With R</p>
</div>
