---
title: 'Debugging the Invalid Descriptor Index Error' 
author: Nick Vasile
date: '2020-05-13'
slug: error-invalid-descriptor-index
categories: []
tags: []
---

**This post is a work in progress**

# Motivation

I use the dbplyr, dplyr, DBI and odbc R packages to extract data held in Microsoft SQL on a daily basis. 

I used to run into the, "Invalid Descriptor Index," error documented [here](https://github.com/r-dbi/odbc/issues/309) constantly. It was awful! I spent so much time trying to find the, "problem," columns in tables that often had over 100 columns. The time I spent trying to get my queries to work severely reduced the time I had available to clean, transform and analyze my data.

Through the work of many great people sharing their expertise on GitHub, I was able to identify [a workaround that worked well for me](https://github.com/r-dbi/odbc/issues/309#issuecomment-615255613).

The workaround helped *me* continue my daily work but did nothing to *prevent* *others* from encountering the same issue in the future. One of the great things about R is the community and I would like to do my part to help. That might involve making a code change in a package or in another component involved.

I don't yet have a firm grasp on what, from a technical standpoint, leads to the failure but I do know many things are involved - specifically multiple R packages, ODBC drivers and Microsoft SQL Server.

I am comfortable as an R user and debugging C++ code individually but have not spent much time debugging multi-component issues in R. 

This investigation is an opportunity for me:

* Advance my R debugging skills so I well-armed to tackle other multi-component R issues in the future
* Understand, at a deep level, the root cause, and contributing factors, of the failure that leads to this error. With that understanding I will be a much better position to propose, evaluate and contribute to solutions.

# Scope

I'll be reproducing this issue using Microsoft SQL Server Express which is a free download available [here](https://www.microsoft.com/en-us/sql-server/sql-server-downloads).

I'll be focusing my analysis on when this error occurs running R on the Microsoft Windows operating system.

# Reproducing the problem

I'll write two different sets of data:

1. A table, "##problem_data," with, "long" columns that are not the last columns in the table.
2. A table, "##working_data," with the same data, only this time with the, "long," column at the end of the table.

```{r}
library(tidyverse)

user_name <-
  keyring::key_list("dbi_test")$username

con <- DBI::dbConnect(
      odbc::odbc(),
      Driver = "SQL Server",
      Server = "testsqlserver",
      UID = user_name,
      PWD = keyring::key_get("dbi_test", user_name)
   )

dplyr::copy_to(con,
               tibble(a = 1:3, 
                      b = blob::blob(raw(1)), #blob data NOT at end of table
                      c = 1
                      ),
               "problem_data", # will expose problem
               temporary = TRUE
               )

dplyr::copy_to(con,
               tibble(a = 1:3,
                      c = 1,
                      b = blob::blob(raw(1)) # blob data at end of table
                      ),
               "working_data", # will not expose problem
               temporary = TRUE
               )
```

Here the problem occurs - because the column with, "long," data is NOT the the last column in the table.

```{r, error = TRUE}
dplyr::tbl(con,"##problem_data")
```

Here the problem does not occur - because the column with "long" data is the last column in the table. 

```{r}
dplyr::tbl(con, "##working_data")
```

SOURCE: https://github.com/r-dbi/odbc/issues/309#issue-507726267 

# Debugging the error

One of the primary motivations for this post is to force me to advance my debugging skills.

I decided to start with [the debugging chapter from Hadley Wickham's Advanced R book](https://adv-r.hadley.nz/debugging.html).

## Debugging Step 1: Google it!

I started out by Googling a portion of the error string, "`[Microsoft][ODBC SQL Server Driver]Invalid Descriptor Index`," which yielded quite a few relevant hits, including a surprising amount of duplicate GitHub issues raised in the odbc project.

Based on Hadley's recommendation in the book I decided to check out the [errorist package](https://github.com/r-assist/errorist) which gave me much more target hits because it included the entire text of the error message in the search string. It was also automatic, saving me a second or two of copying and pasting. I'll be incorporating this package into my debugging work-flow going forward!

I've captured a list of relevant issues, and the Stack Overflow thread I found most helpful in the [Appendix](#issues).

Here is what I gleaned:

1. TODO: something about this being caused by a ODBC (the Microsoft C interface - not the R odbc package) constraint.
2. TODO: The workaround is to put "long" columns at the end of the select statement - there are a few different ways to do this
3. TODO: doesn't occur with: 1) RStudio's professional drivers which are part of their commercial (you need to pay for) offerings 2) RODBC package 3) FreeTDS drivers (*nix systems only)

# Appendix: Some Reports of, and references to, this issue {#issues}

Issues logged against odbc R package:

* https://github.com/r-dbi/odbc/issues/10
* https://github.com/r-dbi/odbc/issues/86
* https://github.com/r-dbi/odbc/issues/112 
* https://github.com/r-dbi/odbc/issues/256
* https://github.com/r-dbi/odbc/issues/309

Issues logged against nanodbc:

* https://github.com/nanodbc/nanodbc/issues/149 

Most Helpful (to me) Stack Overflow thread:

* https://stackoverflow.com/questions/45001152/r-dbi-odbc-error-nanodbc-nanodbc-cpp3110-07009-microsoftodbc-driver-13-fo 


# Q&A

Q: What constitutes "long" data?
A: 